<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Shaka Player Embedded: FFmpeg Encryption</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Shaka Player Embedded
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">FFmpeg Encryption </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes how the encryption info works in FFmpeg. This is for future Shaka Embedded developers who want to add support for different kinds of encryption info to FFmpeg in the future. See <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavutil/encryption_info.h">libavutil/encryption_info.h</a>.</p>
<p>There are two kinds of encryption info: (1) frame-specific encryption info stored as <code>AVEncryptionInfo</code>, and (2) encryption initialization info (e.g. <code>pssh</code> data) stored as <code>AVEncryptionInitInfo</code> on the <code>AVStream</code>.</p>
<p>Also note, in FFmpeg, the encoded (demuxed) frames are called packets (<code>AVPacket</code>), while the decoded frames are called frames (<code>AVFrame</code>). This will still use "frame" to refer to an <code>AVPacket</code>.</p>
<h2>Side data</h2>
<p>The encryption info is stored as side data on either an <code>AVPacket</code> or an <code>AVStream</code>. The side-data itself is binary data. <code>encryption_info.h</code> defines types and methods that can be used independent of container formats. You need to use those methods to convert between the binary format and the generic object.</p>
<p>If you add a side-data to an object that already has a side-data of that type, the old value is replaced. So if there are multiple values (e.g. for multiple <code>pssh</code> support), you'll need to get the old value, parse it, and combine it with the new info you are adding.</p>
<h2>Frame-specific encryption info</h2>
<p>First, you'll need to update the demuxer to parse the encryption info. This will likely involve editing the internal state to include this info. It would be convenient if you used an <code>AVEncryptionInfo</code> object now, but you don't have to.</p>
<p>Next, you need to find where the demuxer creates the frames (<code>AVPacket</code>). This is usually named <code>*_read_packet</code>. In this method, before the frame is returned to the caller, you need to add the side-data to it. If you haven't already, create an <code>AVEncryptionInfo</code> object and fill it with the required info. Then do something like:</p>
<div class="fragment"><div class="line"><span class="comment">// Convert the object to a serialized binary format.</span></div><div class="line"><span class="keywordtype">size_t</span> side_data_size;</div><div class="line">uint8_t *side_data =</div><div class="line">    av_encryption_info_add_side_data(encryption_info, &amp;side_data_size);</div><div class="line"><span class="keywordflow">if</span> (!side_data)</div><div class="line">  <span class="keywordflow">return</span> AVERROR(ENOMEM);</div><div class="line"></div><div class="line"><span class="comment">// Add the data to the packet; this takes ownership of |side_data|.</span></div><div class="line"><span class="keywordtype">int</span> ret = av_packet_add_side_data(</div><div class="line">    &amp;pkt, AV_PKT_DATA_ENCRYPTION_INFO, side_data, side_data_size);</div><div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">  av_free(side_data);</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"><span class="comment">// Remember to free |encryption_info|.</span></div></div><!-- fragment --><h2>Encryption initialization info</h2>
<p>Like before, you'll need to update the demuxer to parse whatever initialization info is required. It should be put into a new <code>AVEncryptionInitInfo</code> struct. Some demuxers support multiple initialization infos, so before setting the stream's side-data, you'll need to determine if there is any existing side-data.</p>
<div class="fragment"><div class="line"><span class="comment">// Find any existing side-data.</span></div><div class="line"><span class="keywordtype">size_t</span> old_side_data_size;</div><div class="line">uint8_t *old_side_data = av_stream_get_side_data(</div><div class="line">    stream, AV_PKT_DATA_ENCRYPTION_INIT_INFO, &amp;old_side_data_size);</div><div class="line"><span class="keywordflow">if</span> (old_side_data) {</div><div class="line">  <span class="comment">// Convert the side-data to a struct and add it to the liked list.</span></div><div class="line">  AVEncryptionInitInfo *old_init_info = av_encryption_init_info_get_side_data(</div><div class="line">      old_side_data, old_side_data_size);</div><div class="line">  <span class="keywordflow">if</span> (old_init_info) {</div><div class="line">    init_info-&gt;next = old_init_info;</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    <span class="keywordflow">return</span> AVERROR(ENOMEM);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Convert the object to a serialized binary format.</span></div><div class="line"><span class="keywordtype">size_t</span> side_data_size;</div><div class="line">uint8_t *side_data = av_encryption_init_info_add_side_data(</div><div class="line">    init_info, &amp;side_data_size);</div><div class="line"><span class="keywordflow">if</span> (!side_data)</div><div class="line">  <span class="keywordflow">return</span> AVERROR(ENOMEM);</div><div class="line"></div><div class="line"><span class="comment">// Add the data to the stream; this takes ownership of |side_data|.</span></div><div class="line"><span class="keywordtype">int</span> ret = av_stream_add_side_data(</div><div class="line">    stream, AV_PKT_DATA_ENCRYPTION_INIT_INFO, side_data, side_data_size);</div><div class="line"><span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">  av_free(side_data);</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"><span class="comment">// Remember to free |init_info|.  Note that av_encryption_init_info_free will</span></div><div class="line"><span class="comment">// free child members.</span></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
